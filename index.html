<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZ Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- মূল স্টুডিও অ্যাপের CSS --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        :root {
            --light-bg: #f9f9f9; --light-surface: #ffffff; --light-text: #0f0f0f; --light-text-secondary: #606060; --light-border: #e0e0e0;
            --dark-bg: #18191A; --dark-surface: #242526; --dark-text: #f1f1f1; --dark-text-secondary: #aaaaaa; --dark-border: #3E4042;
            --accent-color: #4599FF;
            --admin-badge-bg: #f39c12;
            
            /* ইউজার অ্যাপ থেকে আনা থিমের ভ্যারিয়েবল */
            --primary-bg: #18191A; --secondary-bg: #242526; --card-bg: #242526; --header-bg: #242526; --primary-text: #E4E6EB; --secondary-text: #B0B3B8; --divider-color: #3E4042; --input-bg: #3A3B3C;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; transition: background-color 0.3s, color 0.3s; }
        body.light-mode { background-color: var(--light-bg); color: var(--light-text); }
        body.dark-mode { background-color: var(--dark-bg); color: var(--dark-text); }
        .hidden { display: none !important; }
        #login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-box { padding: 40px; border-radius: 8px; width: 320px; text-align: center; }
        body.light-mode .login-box { background-color: var(--light-surface); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        body.dark-mode .login-box { background-color: var(--dark-surface); border: 1px solid var(--dark-border); }
        .login-box h2 { margin-top: 0; margin-bottom: 25px; }
        #login-form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--light-border); border-radius: 4px; box-sizing: border-box; }
        body.dark-mode #login-form input { background-color: #3A3B3C; border-color: var(--dark-border); color: var(--dark-text); }
        #login-form button { width: 100%; padding: 12px; background-color: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: 500; }
        .error-message { color: #f02849; font-size: 14px; height: 20px; margin-top: 15px; }
        #app-container { height: 100vh; display: flex; flex-direction: column; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--dark-border); }
        body.light-mode header { background-color: var(--light-surface); border-bottom-color: var(--light-border); }
        body.dark-mode header { background-color: var(--dark-surface); }
        header .header-left { display: flex; align-items: center; gap: 15px; }
        header h1 { font-size: 24px; margin: 0; }
        header #header-username { font-size: 16px; color: var(--dark-text-secondary); }
        .header-right button { background: none; border: none; font-size: 20px; cursor: pointer; margin-left: 15px; }
        body.light-mode .header-right button { color: var(--light-text-secondary); }
        body.dark-mode .header-right button { color: var(--dark-text-secondary); }
        nav { display: flex; justify-content: space-around; padding: 10px 0; border-bottom: 1px solid var(--dark-border); }
        body.light-mode nav { background-color: var(--light-surface); border-bottom-color: var(--light-border); }
        body.dark-mode nav { background-color: var(--dark-surface); }
        .nav-btn { background: none; border: none; font-size: 16px; padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        body.light-mode .nav-btn { color: var(--light-text-secondary); }
        body.dark-mode .nav-btn { color: var(--dark-text-secondary); }
        .nav-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .nav-btn i { margin-right: 8px; }
        main { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 20px; border-radius: 8px; }
        body.light-mode .stat-card { background-color: var(--light-surface); border: 1px solid var(--light-border); }
        body.dark-mode .stat-card { background-color: var(--dark-surface); border: 1px solid var(--dark-border); }
        .stat-card h3 { margin: 0 0 10px; font-size: 16px; color: var(--dark-text-secondary); }
        .stat-card p { margin: 0; font-size: 28px; font-weight: 500; }
        .post-card { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 8px; margin-bottom: 15px; transition: background-color 0.2s; }
        body.light-mode .post-card:hover { background-color: #f0f0f0; }
        body.dark-mode .post-card:hover { background-color: #313131; }
        body.light-mode .post-card { background-color: var(--light-surface); border: 1px solid var(--light-border); }
        body.dark-mode .post-card { background-color: var(--dark-surface); border: 1px solid var(--dark-border); }
        .post-card-content { flex: 1; cursor: pointer; }
        .post-card p { margin: 0 0 10px; white-space: pre-wrap; word-break: break-word; }
        .post-card-meta { font-size: 12px; color: var(--dark-text-secondary); display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;}
        .post-actions { display: flex; align-items: center; gap: 8px; }
        .studio-badge { background-color: var(--admin-badge-bg); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--accent-color); color: white; border: none; font-size: 24px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 999; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { width: 90%; max-width: 500px; padding: 20px; border-radius: 8px; position: relative; display: flex; flex-direction: column; max-height: 90vh; }
        body.light-mode .modal-content { background-color: var(--light-surface); }
        body.dark-mode .modal-content { background-color: var(--dark-surface); }
        .close-modal-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: inherit; }
        #modal-post-text { font-size: 18px; margin-bottom: 20px; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto;}
        .modal-stats span { margin-right: 20px; font-size: 16px; cursor: pointer; }
        .modal-stats span:hover { color: var(--accent-color); }
        #modal-edit-textarea, #modal-create-textarea, #edit-comment-textarea { width: 100%; box-sizing: border-box; height: 150px; padding: 10px; font-family: inherit; font-size: 16px; border: 1px solid var(--dark-border); margin-bottom: 15px; }
        #edit-comment-textarea { height: 100px; }
        body.dark-mode #modal-edit-textarea, body.dark-mode #modal-create-textarea, body.dark-mode #edit-comment-textarea { background-color: #3A3B3C; border-color: var(--dark-border); color: var(--dark-text); }
        .modal-button { background-color: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%; }
        .modal-button:disabled { background-color: var(--secondary-text); cursor: not-allowed; }
        #list-modal-ul, #comments-list { list-style: none; padding: 0; flex-grow: 1; overflow-y: auto; }
        #list-modal-ul li, .comment-item { padding: 8px 0; border-bottom: 1px solid var(--dark-border); }
        .placeholder-text { color: var(--dark-text-secondary); text-align: center; padding: 40px; }
        .comment-item { display: flex; justify-content: space-between; align-items: flex-start; }
        .comment-content { flex-grow: 1; }
        .comment-author { font-weight: bold; font-size: 0.9em; }
        .comment-text { font-size: 1em; }
        .comment-actions button { background: none; border: none; color: var(--dark-text-secondary); cursor: pointer; margin-left: 8px; font-size: 14px; }
        .btn { padding: 8px 15px; background: var(--accent-color); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        input { padding: 10px; margin-bottom: 12px; border: 1px solid var(--divider-color); background: var(--input-bg); color: var(--primary-text); border-radius: 6px; box-sizing: border-box; }

        /* --- নতুন ফেসবুক-স্টাইল সেটিংস UI CSS (ইউজার অ্যাপ থেকে আনা) --- */
        .view-container { display: none; }
        .view-container.active { display: block; }
        .settings-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .settings-header .back-btn { background: none; border: none; color: var(--primary-text); font-size: 24px; cursor: pointer; padding: 0 10px 0 0; }
        .settings-header h2 { margin: 0; font-size: 20px; }
        .settings-group { background: var(--card-bg); border-radius: 8px; margin-bottom: 20px; }
        .settings-group .group-header { padding: 16px; border-bottom: 1px solid var(--divider-color); }
        .settings-group .group-header h3 { margin: 0; font-size: 1.1em; }
        .settings-group .group-header p { margin: 4px 0 0; color: var(--secondary-text); font-size: 0.9em; }
        .settings-item { display: flex; align-items: center; padding: 14px 16px; cursor: pointer; transition: background-color 0.2s; }
        .settings-item:not(:last-child) { border-bottom: 1px solid var(--divider-color); }
        .settings-item:hover { background-color: var(--input-bg); }
        .settings-item .item-icon { font-size: 22px; margin-right: 16px; width: 24px; text-align: center; color: var(--secondary-text); }
        .settings-item .item-text { flex: 1; }
        .settings-item .item-text p { margin: 0; font-size: 1em; }
        .settings-item .item-text small { color: var(--secondary-text); font-size: 0.85em; }
        .settings-item .item-chevron { font-size: 20px; color: var(--secondary-text); }
        .profile-summary { display: flex; align-items: center; gap: 12px; }
        .profile-summary img { width: 40px; height: 40px; border-radius: 50%; }
        .profile-summary p { font-weight: 500; }
        .pfp-upload-container { margin-bottom: 15px; }
        .pfp-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--divider-color); cursor: pointer; background-color: var(--input-bg); }
        .pfp-upload-container input[type="file"] { display: none; }
        .pfp-upload-container label { display: block; margin-top: 5px; color: var(--accent-color); cursor: pointer; font-weight: bold; }
        
        /* Modal & Follower List CSS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }
        .modal-content-settings { background: var(--secondary-bg); padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 5px 25px rgba(0,0,0,0.4); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--divider-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 24px; color: var(--primary-text); cursor: pointer; }
        .modal-body { overflow-y: auto; }
        .follower-item { display: flex; align-items: center; gap: 12px; padding: 10px 5px; cursor: pointer; border-radius: 6px; }
        .follower-item:hover { background-color: var(--input-bg); }
        .follower-item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .follower-item span { font-weight: bold; }
        
        /* ছবি এডিটর মডাল CSS */
        #image-editor-modal .modal-content { max-width: 500px; }
        #editor-canvas { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 15px; background: var(--input-bg); }
        .editor-controls label { display: block; margin: 10px 0 5px; font-size: 0.9em; color: var(--secondary-text); }
        .editor-controls input[type="range"] { width: 100%; }
        .editor-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn.secondary { background-color: var(--input-bg); color: var(--primary-text); }
        #file-upload-label { cursor: pointer; color: var(--accent-color); font-weight: bold; padding: 8px 12px; border-radius: 6px; display: inline-block;}
        #file-upload-label:hover { background-color: var(--input-bg); }
        #post-file-input { display: none; }
        #file-preview-container img { max-width: 150px; max-height: 150px; border-radius: 8px; margin-top: 10px; }

    </style>
</head>
<body class="dark-mode">

    <!-- লগইন সেকশন -->
    <div id="login-container">
        <div class="login-box">
            <h2>AZ Studio Login</h2>
            <form id="login-form">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <p class="error-message" id="login-error"></p>
        </div>
    </div>

    <!-- মূল অ্যাপ সেকশন -->
    <div id="app-container" class="hidden">
        <header>
            <div class="header-left">
                <h1>AZ Studio</h1>
                <span id="header-username"></span>
            </div>
            <div class="header-right">
                <button id="theme-toggle-btn" title="Toggle Theme"><i class="fas fa-sun"></i></button>
                <button id="logout-btn" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>
        <nav>
            <button class="nav-btn active" onclick="showPage('home-page')"><i class="fas fa-home"></i> Home</button>
            <button class="nav-btn" onclick="showPage('posts-page')"><i class="fas fa-file-alt"></i> Posts</button>
            <button class="nav-btn" onclick="showPage('settings-page')"><i class="fas fa-cog"></i> Settings</button>
        </nav>
        <main>
            <!-- Home Page -->
            <div id="home-page" class="page active">
                <h2>Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Your Reactions</h3><p id="total-reactions">0</p></div>
                    <div class="stat-card"><h3>Your Posts</h3><p id="total-posts">0</p></div>
                    <div class="stat-card"><h3>Followers</h3><p id="dashboard-followers">0</p></div>
                </div>
                <h3>Your Latest Posts</h3>
                <div id="latest-posts-container"><p class="placeholder-text">Loading posts...</p></div>
            </div>
            <!-- Posts Page -->
            <div id="posts-page" class="page">
                <h2>All Your Posts</h2>
                <div id="all-posts-container"><p class="placeholder-text">Loading posts...</p></div>
            </div>
            <!-- Settings Page (New) -->
            <div id="settings-page" class="page">
                <!-- এই কন্টেইনারের ভিতরের কন্টেন্ট JS দিয়ে পরিবর্তন হবে -->
            </div>
        </main>
        <button id="add-post-btn" class="fab"><i class="fas fa-plus"></i></button>
    </div>

    <!-- Modals -->
    <div id="post-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal-btn">×</button>
            <div id="modal-view-mode">
                <p id="modal-post-text"></p>
                <div class="modal-stats">
                    <span id="modal-reactions-count" title="Reactors"><i class="fas fa-heart"></i> 0</span>
                    <span id="modal-comments-count" title="Comments"><i class="fas fa-comment"></i> 0</span>
                </div>
                <button id="edit-post-btn" class="modal-button">Edit Post</button>
            </div>
            <div id="modal-edit-mode" class="hidden">
                <textarea id="modal-edit-textarea"></textarea>
                <button id="save-edit-btn" class="modal-button">Save Changes</button>
            </div>
            <div id="modal-create-mode" class="hidden">
                <h2>Create Studio Post</h2>
                <textarea id="modal-create-textarea" placeholder="What's on your mind?"></textarea>
                <!-- ছবি আপলোডের অংশ -->
                <div id="file-preview-container"></div>
                <div>
                    <label for="post-file-input" id="file-upload-label"><i class="fas fa-image"></i> Add Image</label>
                    <input type="file" id="post-file-input" accept="image/*">
                    <button id="edit-image-btn" class="btn secondary hidden" onclick="openImageEditor()"><i class="fas fa-edit"></i> Edit Image</button>
                </div>
                <button id="submit-post-btn" class="modal-button">Post</button>
            </div>
        </div>
    </div>
    <div id="list-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-list-modal-btn close-modal-btn">×</button>
            <h3 id="list-modal-title"></h3>
            <ul id="list-modal-ul"></ul>
        </div>
    </div>
    <div id="comments-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-comments-modal-btn close-modal-btn">×</button>
            <h3>Comments</h3>
            <div id="comments-list"></div>
        </div>
    </div>
    <div id="edit-comment-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-edit-comment-modal-btn close-modal-btn">×</button>
            <h3>Edit Comment</h3>
            <textarea id="edit-comment-textarea"></textarea>
            <button id="save-comment-btn" class="modal-button">Save</button>
        </div>
    </div>

    <!-- নতুন সেটিংস মডালগুলো -->
    <div id="follower-modal" class="modal">
        <div class="modal-content-settings" onclick="event.stopPropagation()">
            <div class="modal-header"><h3 id="modal-title">Followers</h3><button class="modal-close-btn" onclick="closeSettingsModal('follower-modal')">×</button></div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>
    <div id="password-change-modal" class="modal">
        <div class="modal-content-settings" onclick="event.stopPropagation()">
            <div class="modal-header"><h3>Change Password</h3><button class="modal-close-btn" onclick="closeSettingsModal('password-change-modal')">×</button></div>
            <div class="modal-body">
                <input type="password" id="profile-new-password" placeholder="New Password">
                <p id="password-change-error" class="error-message hidden"></p>
                <button id="update-password-btn" class="btn" style="width: 100%;">Update Password</button>
            </div>
        </div>
    </div>
     <div id="email-change-modal" class="modal">
        <div class="modal-content-settings" onclick="event.stopPropagation()">
            <div class="modal-header"><h3>Change Email</h3><button class="modal-close-btn" onclick="closeSettingsModal('email-change-modal')">×</button></div>
            <div class="modal-body">
                <input type="email" id="new-email-input" placeholder="New Email">
                <input type="password" id="current-password-for-email" placeholder="Current Password">
                <p id="email-change-error" class="error-message hidden"></p>
                <button id="update-email-btn" class="btn" style="width: 100%;">Update Email</button>
            </div>
        </div>
    </div>
    <div id="image-editor-modal" class="modal">
         <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header"><h3>Edit Image</h3><button class="modal-close-btn" onclick="closeSettingsModal('image-editor-modal')">×</button></div>
            <div class="modal-body">
                <canvas id="editor-canvas"></canvas>
                <div class="editor-controls">
                    <label for="brightness-slider">Brightness</label>
                    <input type="range" id="brightness-slider" min="0" max="200" value="100">
                    <label for="saturate-slider">Saturation</label>
                    <input type="range" id="saturate-slider" min="0" max="200" value="100">
                </div>
            </div>
            <div class="editor-footer">
                <button class="btn secondary" onclick="closeSettingsModal('image-editor-modal')">Cancel</button>
                <button class="btn" onclick="applyImageEdits()">Apply</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD8VE2szfSRYfFZAG1z-HCV_EN4KqiE9y8",
            authDomain: "adda-zone-f042f.firebaseapp.com",
            databaseURL: "https://adda-zone-f042f-default-rtdb.firebaseio.com",
            projectId: "adda-zone-f042f",
            storageBucket: "adda-zone-f042f.appspot.com",
            appId: "1:476848720841:android:809464e9deed793452b618"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let allUsers = {};
        let currentUser = null; // Changed from auth.currentUser to a global variable
        let currentPostId = null;
        let currentEditingCommentId = null;
        const DEFAULT_PFP = 'https://i.ibb.co/68JjYtW/default-pfp.png';
        let selectedPostFile = null;
        let originalSelectedPostFile = null;
        let selectedProfilePfpFile = null;

        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const totalReactionsEl = document.getElementById('total-reactions');
        const totalPostsEl = document.getElementById('total-posts');
        const dashboardFollowersEl = document.getElementById('dashboard-followers');
        const latestPostsContainer = document.getElementById('latest-posts-container');
        const allPostsContainer = document.getElementById('all-posts-container');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const addPostBtn = document.getElementById('add-post-btn');
        const postModal = document.getElementById('post-modal');
        const listModal = document.getElementById('list-modal');
        const commentsModal = document.getElementById('comments-modal');
        const editCommentModal = document.getElementById('edit-comment-modal');

        // --- Authentication Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user; // Set the global currentUser
                loginContainer.style.display = 'none';
                appContainer.classList.remove('hidden');
                setupFirebaseListeners();
                loadProfileData(); // নতুন ফাংশন কল
            } else {
                currentUser = null;
                loginContainer.style.display = 'flex';
                appContainer.classList.add('hidden');
                if (db) { db.ref('posts').off(); db.ref('users').off(); }
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    loginError.textContent = "Incorrect email or password.";
                });
        });

        logoutBtn.addEventListener('click', () => { auth.signOut(); });

        // --- Main App Functions ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-btn[onclick="showPage('${pageId}')"]`).classList.add('active');
            
            // যদি সেটিংস পেজ হয়, তাহলে প্রধান সেটিংস ভিউ দেখাও
            if (pageId === 'settings-page') {
                showSettingsView('main-settings');
            }
        }

        function createPostCard(postData, postId) {
            const card = document.createElement('div');
            card.className = 'post-card';
            const reactions = postData.reactions ? Object.keys(postData.reactions).length : 0;
            const postDate = postData.timestamp ? new Date(postData.timestamp).toLocaleDateString() : 'No Date';
            const isStudioPost = postData.isStudioPost === true;
            
            const postActionsHTML = `
                <div class="post-actions">
                    ${isStudioPost ? '<span class="studio-badge">Studio</span>' : ''}
                    <button onclick="deletePost('${postId}')" style="background:none; border:none; color:var(--accent-color); font-size:16px; cursor:pointer;"><i class="fas fa-trash"></i></button>
                </div>`;

            card.innerHTML = `
                <div class="post-card-content" onclick="openPostModal('${postId}')">
                    ${postData.mediaUrl ? `<img src="${postData.mediaUrl}" style="max-width:100px; border-radius:4px; margin-bottom:10px;">` : ''}
                    <p>${postData.text || "No content"}</p>
                    <div class="post-card-meta">
                        <span>By: ${postData.authorUsername || "Unknown"}</span>
                        <span><i class="fas fa-heart"></i> ${reactions} | ${postDate}</span>
                    </div>
                </div>
                ${postActionsHTML}`;
            return card;
        }
        
        function updateUI(postsSnapshot) {
            const userPosts = postsSnapshot.val() || {};
            const postsArray = Object.entries(userPosts).map(([id, data]) => ({ id, ...data }));
            
            totalPostsEl.textContent = postsArray.length;
            totalReactionsEl.textContent = postsArray.reduce((sum, post) => sum + (post.reactions ? Object.keys(post.reactions).length : 0), 0);

            const sortedPosts = postsArray.sort((a, b) => b.timestamp - a.timestamp);

            allPostsContainer.innerHTML = '';
            latestPostsContainer.innerHTML = '';

            if (sortedPosts.length === 0) {
                const placeholder = '<p class="placeholder-text">You have not created any posts yet.</p>';
                allPostsContainer.innerHTML = placeholder;
                latestPostsContainer.innerHTML = placeholder;
                return;
            }
            
            sortedPosts.forEach(post => {
                allPostsContainer.appendChild(createPostCard(post, post.id));
            });

            sortedPosts.slice(0, 3).forEach(post => {
                const cardClone = createPostCard(post, post.id);
                cardClone.querySelector('.post-card-content').onclick = () => openPostModal(post.id);
                const deleteBtn = cardClone.querySelector('button');
                if (deleteBtn) deleteBtn.onclick = () => deletePost(post.id);
                latestPostsContainer.appendChild(cardClone);
            });
        }

        function setupFirebaseListeners() {
            if (!currentUser) return;
            db.ref('users').on('value', snapshot => { allUsers = snapshot.val() || {}; });
            const userPostsRef = db.ref('posts').orderByChild('authorUid').equalTo(currentUser.uid);
            userPostsRef.on('value', updateUI);
        }
        
        function deletePost(postId) {
            event.stopPropagation();
            if (confirm('Are you sure you want to delete this post?')) {
                db.ref(`posts/${postId}`).remove().catch(e => alert('Error: ' + e.message));
            }
        }
        
        // --- Modal Functions ---
        function openPostModal(postId) { /* ... আগের মতোই ... */ }
        
        addPostBtn.addEventListener('click', () => {
            document.getElementById('modal-view-mode').classList.add('hidden');
            document.getElementById('modal-edit-mode').classList.add('hidden');
            document.getElementById('modal-create-mode').classList.remove('hidden');
            document.getElementById('modal-create-textarea').value = '';
            document.getElementById('file-preview-container').innerHTML = '';
            document.getElementById('edit-image-btn').classList.add('hidden');
            selectedPostFile = null;
            originalSelectedPostFile = null;
            postModal.style.display = 'flex';
        });

        document.getElementById('submit-post-btn').addEventListener('click', async () => {
            const text = document.getElementById('modal-create-textarea').value.trim();
            const postBtn = document.getElementById('submit-post-btn');
            if (!text && !selectedPostFile) return;

            postBtn.disabled = true; postBtn.textContent = 'Posting...';

            let mediaUrl = selectedPostFile ? await uploadImageToImgBB(selectedPostFile) : null;
            if (selectedPostFile && !mediaUrl) {
                alert('Image upload failed. Post was not created.');
                postBtn.disabled = false; postBtn.textContent = 'Post';
                return;
            }
            
            const newPost = {
                text: text,
                authorUid: currentUser.uid,
                authorUsername: allUsers[currentUser.uid]?.username || "AZ Studio Admin",
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                isStudioPost: true
            };

            if(mediaUrl) {
                newPost.mediaUrl = mediaUrl;
                newPost.mediaType = 'image';
            }

            db.ref('posts').push(newPost)
                .then(() => { 
                    postModal.style.display = 'none'; 
                    postBtn.disabled = false; postBtn.textContent = 'Post';
                })
                .catch(e => { 
                    alert('Error: ' + e.message);
                    postBtn.disabled = false; postBtn.textContent = 'Post';
                });
        });
        
        // --- Theme and Other functions from original file ---
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.modal-overlay').style.display = 'none';
                if(e.target.closest('#comments-modal')) {
                    if (currentPostId) db.ref(`posts/${currentPostId}/comments`).off();
                }
            });
        });
        themeToggleBtn.addEventListener('click', () => { /* ... আগের মতোই ... */ });
        
        //======================================================================
        //      ইউজার অ্যাপ থেকে আনা নতুন ফাংশনালিটি
        //======================================================================

        const settingsContainer = document.getElementById('settings-page');

        function showSettingsView(viewId) {
            settingsContainer.innerHTML = ''; // Clear previous view
            let viewContent = '';

            switch (viewId) {
                case 'main-settings':
                    viewContent = `
                        <div class="settings-header"><h2>Settings & privacy</h2></div>
                        <div class="settings-group">
                            <div class="group-header"><h3>Accounts Center</h3><p>Manage your connected experiences and account settings.</p></div>
                            <div class="settings-item" onclick="showSettingsView('accounts-center')">
                                 <div class="item-icon">👤</div><div class="item-text"><p>Personal details, password and security</p></div><div class="item-chevron">›</div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="group-header"><h3>Followers & Following</h3></div>
                             <div class="settings-item" onclick="showFollowerList(currentUser.uid, 'followers')">
                                 <div class="item-icon">👥</div><div class="item-text"><p>Followers</p></div><div id="my-followers-count" class="item-chevron">0</div>
                             </div>
                             <div class="settings-item" onclick="showFollowerList(currentUser.uid, 'following')">
                                 <div class="item-icon">👍</div><div class="item-text"><p>Following</p></div><div id="my-following-count" class="item-chevron">0</div>
                             </div>
                        </div>`;
                    break;
                case 'accounts-center':
                    viewContent = `
                        <div class="settings-header"><button class="back-btn" onclick="showSettingsView('main-settings')">←</button><h2>Accounts Center</h2></div>
                        <div class="settings-group">
                            <div class="settings-item" style="cursor: default;">
                                 <div class="profile-summary"><img id="ac-pfp" src="${DEFAULT_PFP}"><div><p id="ac-username">Username</p><small>Adda Zone</small></div></div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="group-header" style="border: none;"><h3>Account settings</h3></div>
                            <div class="settings-item" onclick="showSettingsView('personal-details')"><div class="item-icon">📝</div><div class="item-text"><p>Personal details</p></div><div class="item-chevron">›</div></div>
                            <div class="settings-item" onclick="showSettingsView('password-security')"><div class="item-icon">🛡️</div><div class="item-text"><p>Password and security</p></div><div class="item-chevron">›</div></div>
                        </div>`;
                    break;
                case 'personal-details':
                    viewContent = `
                        <div class="settings-header"><button class="back-btn" onclick="showSettingsView('accounts-center')">←</button><h2>Personal details</h2></div>
                        <div class="settings-group">
                             <div class="group-header"><h3>Contact info</h3></div>
                             <div class="settings-item" onclick="openEmailChangeModal()"><div class="item-text"><p id="pd-email"></p><small>Email</small></div><div class="item-chevron">›</div></div>
                        </div>
                        <div class="settings-group">
                             <div class="group-header"><h3>Profile Management</h3></div>
                             <div class="settings-item" onclick="showSettingsView('profile-edit')"><div class="item-text"><p>Edit Username & Picture</p></div><div class="item-chevron">›</div></div>
                        </div>`;
                    break;
                case 'password-security':
                     viewContent = `
                        <div class="settings-header"><button class="back-btn" onclick="showSettingsView('accounts-center')">←</button><h2>Password and security</h2></div>
                        <div class="settings-group">
                            <div class="group-header"><h3>Login & recovery</h3></div>
                            <div class="settings-item" onclick="openPasswordChangeModal()"><div class="item-text"><p>Change password</p></div><div class="item-chevron">›</div></div>
                        </div>`;
                    break;
                case 'profile-edit':
                    viewContent = `
                        <div class="settings-header"><button class="back-btn" onclick="showSettingsView('personal-details')">←</button><h2>Edit Profile</h2></div>
                        <div class="settings-group" style="padding: 20px;">
                            <div class="pfp-upload-container" style="text-align: center;">
                                <label for="profile-pfp-input"><img id="profile-pfp-preview" class="pfp-preview" src="${DEFAULT_PFP}"></label>
                                <label for="profile-pfp-input">Change profile picture</label>
                                <input id="profile-pfp-input" type="file" accept="image/*">
                                <button id="update-pfp-btn" class="btn" style="margin-top: 10px; width: auto;">Update Picture</button>
                            </div>
                        </div>
                        <div class="settings-group" style="padding: 20px;">
                            <label>Username</label><br><input type="text" id="profile-username" style="width: 100%;">
                            <button id="update-username-btn" class="btn" style="width: 100%;">Update Username</button>
                        </div>`;
                    break;
            }
            settingsContainer.innerHTML = viewContent;
            
            // Re-bind events for newly created elements
            if (viewId === 'profile-edit') {
                 document.getElementById('profile-pfp-input').addEventListener('change', (e) => { selectedProfilePfpFile = e.target.files[0]; if(selectedProfilePfpFile) document.getElementById('profile-pfp-preview').src = URL.createObjectURL(selectedProfilePfpFile); });
                 document.getElementById('update-pfp-btn').addEventListener('click', updatePfp);
                 document.getElementById('update-username-btn').addEventListener('click', updateUsername);
            }
            
            // Populate data after rendering
            loadProfileData();
        }
        
        function loadProfileData() {
            if (!currentUser) return;
            db.ref('users/' + currentUser.uid).on('value', s => {
                if (!s.exists()) return;
                const d = s.val();
                document.getElementById('header-username').textContent = d.username || '';
                if(document.getElementById('ac-username')) document.getElementById('ac-username').textContent = d.username || '';
                if(document.getElementById('ac-pfp')) document.getElementById('ac-pfp').src = d.pfpUrl || DEFAULT_PFP;
                if(document.getElementById('pd-email')) document.getElementById('pd-email').textContent = d.email || '';
                const followersCount = d.followers ? Object.keys(d.followers).length : 0;
                if(document.getElementById('my-followers-count')) document.getElementById('my-followers-count').textContent = followersCount;
                dashboardFollowersEl.textContent = followersCount;
                if(document.getElementById('my-following-count')) document.getElementById('my-following-count').textContent = d.following ? Object.keys(d.following).length : 0;
                if(document.getElementById('profile-username')) document.getElementById('profile-username').value = d.username || '';
                if(document.getElementById('profile-pfp-preview')) document.getElementById('profile-pfp-preview').src = d.pfpUrl || DEFAULT_PFP;
            });
        }
        
        async function updatePfp() {
            const btn = document.getElementById('update-pfp-btn');
            if (!selectedProfilePfpFile) return alert("Please select a new picture.");
            btn.disabled = true; btn.textContent = 'Updating...';
            const url = await uploadImageToImgBB(selectedProfilePfpFile);
            if (url) {
                await db.ref('users/' + currentUser.uid).update({ pfpUrl: url });
                alert('Profile picture updated!');
                document.getElementById('profile-pfp-preview').src = url; selectedProfilePfpFile = null; document.getElementById('profile-pfp-input').value = '';
            } else alert('Failed to update picture.');
            btn.disabled = false; btn.textContent = 'Update Picture';
        }

        function updateUsername() {
            const newUsername = document.getElementById('profile-username').value.trim();
            if (newUsername) db.ref('users/' + currentUser.uid).update({ username: newUsername }).then(() => alert('Username updated!'));
        }

        function openPasswordChangeModal() { document.getElementById('password-change-modal').classList.add('show'); }
        function openEmailChangeModal() { document.getElementById('email-change-modal').classList.add('show'); }
        function closeSettingsModal(modalId) { document.getElementById(modalId).classList.remove('show'); }
        
        document.getElementById('update-password-btn').addEventListener('click', () => { /* ... আগের মতোই ... */ });
        document.getElementById('update-email-btn').addEventListener('click', async () => { /* ... আগের মতোই ... */ });
        
        async function showFollowerList(userId, listType) {
            const modal = document.getElementById('follower-modal');
            modal.classList.add('show');
            document.getElementById('modal-title').textContent = listType.charAt(0).toUpperCase() + listType.slice(1);
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = '<div class="stat-card">Loading...</div>';
            const listSnapshot = await db.ref(`users/${userId}/${listType}`).once('value');
            if (!listSnapshot.exists()) { modalBody.innerHTML = '<div class="stat-card">This list is empty.</div>'; return; }
            modalBody.innerHTML = '';
            for (const id of Object.keys(listSnapshot.val())) {
                const userSnap = await db.ref(`users/${id}`).once('value');
                if (userSnap.exists()) {
                    const d = userSnap.val();
                    const item = document.createElement('div');
                    item.className = 'follower-item';
                    item.innerHTML = `<img src="${d.pfpUrl || DEFAULT_PFP}" alt="pfp"><span>${d.username}</span>`;
                    modalBody.appendChild(item);
                }
            }
        }
        
        // ছবি আপলোড এবং এডিটিং ফাংশন
        async function uploadImageToImgBB(file) {
            const apiKey = '5c06b68a2e5e23254bacd840f4ad2343'; 
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
                const result = await response.json();
                return result.success ? result.data.url : null;
            } catch (error) { console.error(error); return null; }
        }

        document.getElementById('post-file-input').addEventListener('change', (event) => {
            selectedPostFile = event.target.files[0];
            originalSelectedPostFile = selectedPostFile; 
            if (selectedPostFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('file-preview-container').innerHTML = `<img src="${e.target.result}" alt="preview">`;
                };
                reader.readAsDataURL(selectedPostFile);
                document.getElementById('edit-image-btn').classList.remove('hidden'); 
            } else {
                document.getElementById('file-preview-container').innerHTML = '';
                 document.getElementById('edit-image-btn').classList.add('hidden'); 
            }
        });

        const canvas = document.getElementById('editor-canvas');
        const ctx = canvas.getContext('2d');
        const editorSliders = {
            brightness: document.getElementById('brightness-slider'),
            saturate: document.getElementById('saturate-slider'),
        };
        let editorImage = new Image();

        function openImageEditor() {
            if (!originalSelectedPostFile) return;
            editorImage.onload = () => {
                canvas.width = editorImage.width;
                canvas.height = editorImage.height;
                applyCanvasFilters();
                document.getElementById('image-editor-modal').classList.add('show');
            };
            editorImage.src = URL.createObjectURL(originalSelectedPostFile);
        }

        function applyCanvasFilters() {
            const filters = `brightness(${editorSliders.brightness.value}%) saturate(${editorSliders.saturate.value}%)`;
            ctx.filter = filters;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(editorImage, 0, 0);
        }

        Object.values(editorSliders).forEach(slider => slider.addEventListener('input', applyCanvasFilters));
        
        function applyImageEdits() {
            canvas.toBlob(blob => {
                selectedPostFile = new File([blob], originalSelectedPostFile.name, { type: 'image/png' });
                const previewImg = document.getElementById('file-preview-container').querySelector('img');
                if (previewImg) previewImg.src = URL.createObjectURL(selectedPostFile);
                closeSettingsModal('image-editor-modal');
            }, 'image/png');
        }

    </script>
</body>
</html>